<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#4a90e2">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="./manifest.json">
<title>Sudoku</title>
<style>
/* â”€â”€ Reset & base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box;}

/* Fix #1: PWA fullscreen â€” use 100% height on html/body
   and dvh (dynamic viewport height) which accounts for
   browser chrome, notches, and standalone mode on all devices. */
html{height:100%;}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  /* Fallback then preferred unit */
  min-height:100vh;
  min-height:100dvh;
  /* Safe-area padding for notched phones in standalone mode */
  padding:env(safe-area-inset-top,10px) env(safe-area-inset-right,10px) env(safe-area-inset-bottom,10px) env(safe-area-inset-left,10px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:#333;
}
/* iOS Safari standalone workaround */
@supports (-webkit-touch-callout:none){
  body{min-height:-webkit-fill-available;}
}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.container{max-width:600px;width:100%;background:white;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.2);padding:16px;display:flex;flex-direction:column;gap:12px;}
h1{text-align:center;color:#4a90e2;font-size:clamp(1.4rem,5vw,2.2rem);text-shadow:2px 2px 4px rgba(0,0,0,0.1);}

/* â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats{display:flex;justify-content:space-around;gap:8px;flex-wrap:wrap;}
.stat{flex:1;min-width:70px;background:#f0f4f8;padding:8px;border-radius:8px;text-align:center;}
.stat-label{font-size:0.72rem;color:#666;text-transform:uppercase;letter-spacing:0.5px;}
.stat-value{font-size:1.4rem;font-weight:bold;color:#4a90e2;margin-top:4px;}

/* â”€â”€ Difficulty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.difficulty{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
.diff-btn{flex:1;min-width:70px;padding:10px 16px;border:2px solid #4a90e2;background:white;color:#4a90e2;border-radius:8px;cursor:pointer;font-size:0.95rem;font-weight:600;transition:all 0.3s;text-transform:uppercase;letter-spacing:0.5px;}
.diff-btn:hover{background:#4a90e2;color:white;transform:translateY(-2px);box-shadow:0 4px 12px rgba(74,144,226,0.3);}
.diff-btn.active{background:#4a90e2;color:white;box-shadow:0 4px 12px rgba(74,144,226,0.3);}

/* â”€â”€ Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.message{text-align:center;padding:10px;border-radius:8px;font-weight:600;min-height:44px;display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;}
.message.error{background:#ffe0e0;color:#d32f2f;border:2px solid #d32f2f;}
.message.success{background:#e0f7e9;color:#2e7d32;border:2px solid #2e7d32;}
.message.hidden{display:none;}
.restart-link{color:inherit;text-decoration:underline;cursor:pointer;font-weight:700;}

/* â”€â”€ Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.game-container{aspect-ratio:1;width:100%;max-width:500px;margin:0 auto;position:relative;}
.grid{display:grid;grid-template-columns:repeat(9,1fr);grid-template-rows:repeat(9,1fr);gap:0;border:3px solid #333;background:#333;width:100%;height:100%;border-radius:4px;overflow:hidden;}
.grid.error-border{border-color:#d32f2f;animation:shake 0.5s;}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);}}
.cell{background:white;border:1px solid #ccc;display:flex;align-items:center;justify-content:center;font-size:clamp(0.9rem,3vw,1.4rem);font-weight:600;cursor:pointer;transition:background 0.15s;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;position:relative;overflow:hidden;}
.cell:nth-child(3n):not(:nth-child(9n)){border-right:2px solid #333;}
.cell:nth-child(n+19):nth-child(-n+27),.cell:nth-child(n+46):nth-child(-n+54){border-bottom:2px solid #333;}
.cell.given{background:#f0f4f8;color:#333;font-weight:700;}
.cell.filled{color:#4a90e2;}
.cell.selected{background:#bbdefb;box-shadow:inset 0 0 0 2px #4a90e2;}
.cell.conflict{background:#ffcccc;color:#d32f2f;}
.cell.same-number-highlight{background:#fff59d;font-weight:700;}
.cell:hover:not(.given){background:#e3f2fd;}

/* â”€â”€ Notes in cells â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cell-notes{position:absolute;top:0;left:0;right:0;bottom:0;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);padding:1px;pointer-events:none;}
.cell-note{display:flex;align-items:center;justify-content:center;font-size:clamp(0.45rem,1.5vw,0.75rem);color:#555;font-weight:500;line-height:1;}
.cell.selected .cell-note{color:#1a237e;}

/* â”€â”€ Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px;
  padding-top:max(16px,env(safe-area-inset-top));
  padding-bottom:max(16px,env(safe-area-inset-bottom));
}
.popup.active{display:flex;}
.popup-content{background:white;border-radius:12px;padding:16px;max-width:380px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.3);}
.popup-header{text-align:center;font-size:0.85rem;font-weight:600;color:#666;margin-bottom:10px;min-height:18px;}

/* Number/position grid */
.number-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
.number-btn{padding:18px 8px;background:#f0f4f8;border:2px solid #4a90e2;border-radius:8px;font-size:1.4rem;font-weight:bold;cursor:pointer;transition:all 0.15s;color:#4a90e2;min-height:56px;display:flex;align-items:center;justify-content:center;}
.number-btn:hover{background:#4a90e2;color:white;transform:scale(1.05);}

/* Position selector buttons (notes mode) */
.pos-btn{background:#f5f5f5;border:2px dashed #aaa;color:#999;font-size:0.85rem;}
.pos-btn.has-note{background:#e8f4fd;border-color:#4a90e2;color:#1565c0;font-size:1.2rem;font-weight:700;}
.pos-btn.clear-mode{background:#fff3e0;border-color:#ff9800;color:#e65100;}
.pos-btn:hover{background:#e3f2fd;border-color:#4a90e2;color:#4a90e2;}
.pos-btn.has-note:hover{background:#bbdefb;}
.pos-spacer{visibility:hidden;pointer-events:none;}

/* Popup action buttons */
.popup-actions{display:flex;gap:8px;}
.popup-btn{flex:1;padding:11px 6px;border:2px solid #4a90e2;background:white;color:#4a90e2;border-radius:8px;cursor:pointer;font-weight:600;font-size:0.9rem;transition:all 0.2s;}
.popup-btn:hover{background:#4a90e2;color:white;}
.popup-btn.notes-active{background:#7c4dff;border-color:#7c4dff;color:white;}
.popup-btn.notes-active:hover{background:#6039c8;border-color:#6039c8;}

/* â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.control-btn{padding:9px 18px;border:2px solid #666;background:white;color:#666;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s;font-size:0.9rem;}
.control-btn:hover{background:#666;color:white;transform:translateY(-2px);}
.install-btn{background:#4caf50;color:white;border:2px solid #4caf50;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s;display:none;font-size:0.9rem;}
.install-btn:hover{background:#45a049;transform:translateY(-2px);box-shadow:0 4px 12px rgba(76,175,80,0.3);}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ§© Sudoku</h1>
  <div class="stats">
    <div class="stat"><div class="stat-label">Easy</div><div class="stat-value" id="easyWins">0</div></div>
    <div class="stat"><div class="stat-label">Medium</div><div class="stat-value" id="mediumWins">0</div></div>
    <div class="stat"><div class="stat-label">Hard</div><div class="stat-value" id="hardWins">0</div></div>
  </div>
  <div class="difficulty">
    <button class="diff-btn active" data-level="easy">Easy</button>
    <button class="diff-btn" data-level="medium">Medium</button>
    <button class="diff-btn" data-level="hard">Hard</button>
  </div>
  <div class="message hidden" id="message"></div>
  <div class="game-container">
    <div class="grid" id="grid"></div>
  </div>
  <div class="controls">
    <button class="control-btn" id="newGame">New Game</button>
    <button class="control-btn" id="undoBtn">Undo</button>
    <button class="install-btn" id="installBtn">Install App</button>
  </div>
</div>

<!-- Number / Notes popup -->
<div class="popup" id="popup">
  <div class="popup-content">
    <div class="popup-header" id="popupHeader"></div>
    <div class="number-grid" id="numberGrid"></div>
    <div class="popup-actions">
      <button class="popup-btn" id="clearCell">Clear</button>
      <button class="popup-btn" id="notesToggle">Notes</button>
      <button class="popup-btn" id="closePopup">Cancel</button>
    </div>
  </div>
</div>

<script>
class SudokuGame {
  constructor() {
    // Core grid state
    this.grid    = Array(9).fill(null).map(() => Array(9).fill(0));
    this.solution= Array(9).fill(null).map(() => Array(9).fill(0));
    this.given   = Array(9).fill(null).map(() => Array(9).fill(false));
    this.level   = 'easy';
    this.selected= null;
    this.lastNumber = 0;
    this.history = [];

    // Notes state â€” notes[row][col] = { [pos1..4,6..9]: number }
    // positions mirror the 3Ã—3 number-grid layout; pos 5 (centre) is unused
    this.notes   = Array(9).fill(null).map(() => Array(9).fill(null).map(() => ({})));

    // Notes-mode UI state
    this.notesMode         = false;  // toggle button on/off
    this.notesPhase        = 'position'; // 'position' | 'number'
    this.notesClearMode    = false;  // true when clearing a note position
    this.noteSelectedPos   = null;   // which position was chosen in phase 'position'

    this.stats = JSON.parse(localStorage.getItem('sudokuStats')) || {easy:0,medium:0,hard:0};
    this.deferredPrompt = null;
    this.checkPWAInstalled();
    this.init();
  }

  // â”€â”€ Initialise â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  init() {
    this.updateStats();
    this.createGrid();
    this.loadGame();
    document.querySelectorAll('.diff-btn').forEach(btn =>
      btn.addEventListener('click', () => this.changeDifficulty(btn.dataset.level))
    );
    document.getElementById('newGame').addEventListener('click', () => this.confirmNewGame());
    document.getElementById('undoBtn').addEventListener('click', () => this.undo());
    document.getElementById('closePopup').addEventListener('click', () => this.closePopup());
    document.getElementById('clearCell').addEventListener('click', () => this.handleClear());
    document.getElementById('notesToggle').addEventListener('click', () => this.toggleNotesMode());
    document.getElementById('popup').addEventListener('click', e => {
      if (e.target.id === 'popup') this.closePopup();
    });
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      this.deferredPrompt = e;
      document.getElementById('installBtn').style.display = 'block';
    });
    document.getElementById('installBtn').addEventListener('click', () => this.installApp());

    // Fix #2 (offline): register SW relative to this file so scope is correct
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW registered', reg.scope))
        .catch(err => console.warn('SW registration failed (offline-first still works from cache)', err));
    }
  }

  // â”€â”€ Grid DOM creation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  createGrid() {
    const gridEl = document.getElementById('grid');
    gridEl.innerHTML = '';
    for (let i = 0; i < 81; i++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.index = i;
      cell.addEventListener('click', () => this.selectCell(i));
      cell.addEventListener('contextmenu', e => {
        e.preventDefault();
        this.selectCell(i);
        this.showPopup();
      });
      let touchTimer;
      cell.addEventListener('touchstart', e => {
        touchTimer = setTimeout(() => {
          e.preventDefault();
          this.selectCell(i);
          this.showPopup();
        }, 500);
      });
      cell.addEventListener('touchend', () => clearTimeout(touchTimer));
      cell.addEventListener('touchmove', () => clearTimeout(touchTimer));
      gridEl.appendChild(cell);
    }
  }

  // â”€â”€ Puzzle generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  generateSolution() {
    this.solution = Array(9).fill(null).map(() => Array(9).fill(0));
    this.fillGrid(this.solution);
  }

  fillGrid(grid, row=0, col=0) {
    if (row === 9) return true;
    if (col === 9) return this.fillGrid(grid, row+1, 0);
    const nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random()-0.5);
    for (const num of nums) {
      if (this.isValid(grid, row, col, num)) {
        grid[row][col] = num;
        if (this.fillGrid(grid, row, col+1)) return true;
        grid[row][col] = 0;
      }
    }
    return false;
  }

  isValid(grid, row, col, num) {
    for (let i=0; i<9; i++) {
      if (grid[row][i]===num || grid[i][col]===num) return false;
    }
    const br=Math.floor(row/3)*3, bc=Math.floor(col/3)*3;
    for (let i=0; i<3; i++) for (let j=0; j<3; j++) {
      if (grid[br+i][bc+j]===num) return false;
    }
    return true;
  }

  canPlaceNumber(row, col, num) {
    const br=Math.floor(row/3)*3, bc=Math.floor(col/3)*3;
    for (let i=0; i<3; i++) for (let j=0; j<3; j++) {
      if (this.grid[br+i][bc+j]===num) return false;
    }
    return true;
  }

  // â”€â”€ New game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  newGame() {
    this.generateSolution();
    this.grid  = this.solution.map(r => [...r]);
    this.given = Array(9).fill(null).map(() => Array(9).fill(false));
    this.notes = Array(9).fill(null).map(() => Array(9).fill(null).map(() => ({})));
    this.history = [];
    this.selected = null;
    this.lastNumber = 0;
    this.resetNotesUI();

    const toRemove = {easy:35, medium:45, hard:55}[this.level];
    let removed = 0;
    while (removed < toRemove) {
      const r=Math.floor(Math.random()*9), c=Math.floor(Math.random()*9);
      if (this.grid[r][c] !== 0) { this.grid[r][c]=0; removed++; }
    }
    for (let i=0; i<9; i++) for (let j=0; j<9; j++) {
      if (this.grid[i][j] !== 0) this.given[i][j]=true;
    }
    this.saveGame();
    this.render();
    this.hideMessage();
  }

  changeDifficulty(level) {
    this.level = level;
    document.querySelectorAll('.diff-btn').forEach(btn =>
      btn.classList.toggle('active', btn.dataset.level===level)
    );
    this.newGame();
  }

  // â”€â”€ Cell selection / popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  selectCell(index) {
    const row=Math.floor(index/9), col=index%9;
    if (this.given[row][col]) return;
    this.selected = index;
    const val = this.grid[row][col];
    if (val > 0) { this.showPopup(); this.render(); return; }
    if (!this.notesMode && this.lastNumber>0 && this.canPlaceNumber(row,col,this.lastNumber)) {
      this.placeNumber(this.lastNumber);
    } else {
      this.showPopup();
    }
    this.render();
  }

  // â”€â”€ Popup rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  showPopup() {
    if (this.selected===null) return;
    const popup   = document.getElementById('popup');
    const numGrid = document.getElementById('numberGrid');
    const header  = document.getElementById('popupHeader');
    numGrid.innerHTML = '';

    const row=Math.floor(this.selected/9), col=this.selected%9;
    const cellNotes = this.notes[row][col];

    if (this.notesMode && this.notesPhase==='position') {
      // â”€â”€ Phase 1: choose a position within the cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (this.notesClearMode) {
        header.textContent = 'Tap position to clear note';
      } else {
        header.textContent = 'Tap position to place note';
      }

      for (let pos=1; pos<=9; pos++) {
        if (pos===5) {
          // Centre position is unused â€” render an invisible spacer
          const spacer = document.createElement('div');
          spacer.className = 'number-btn pos-spacer';
          numGrid.appendChild(spacer);
          continue;
        }

        const existingNote = cellNotes[pos];

        if (this.notesClearMode) {
          // In clear mode: only show buttons for positions that actually have notes
          const btn = document.createElement('button');
          btn.className = 'number-btn pos-btn';
          if (existingNote) {
            btn.textContent = existingNote;
            btn.classList.add('has-note', 'clear-mode');
            btn.addEventListener('click', () => this.clearNote(pos));
          } else {
            // No note here â€” dim / disabled
            btn.textContent = '';
            btn.style.opacity = '0.15';
            btn.disabled = true;
          }
          numGrid.appendChild(btn);
        } else {
          // Place mode: show all 8 positions; show existing note value if present
          const btn = document.createElement('button');
          btn.className = 'number-btn pos-btn';
          if (existingNote) {
            btn.textContent = existingNote;
            btn.classList.add('has-note');
          }
          btn.addEventListener('click', () => this.selectNotePosition(pos));
          numGrid.appendChild(btn);
        }
      }

    } else if (this.notesMode && this.notesPhase==='number') {
      // â”€â”€ Phase 2: choose the number to write at the selected position â”€â”€â”€â”€â”€â”€â”€
      header.textContent = 'Select number for note';
      for (let i=1; i<=9; i++) {
        const btn = document.createElement('button');
        btn.className = 'number-btn';
        btn.textContent = i;
        btn.addEventListener('click', () => this.placeNote(i));
        numGrid.appendChild(btn);
      }

    } else {
      // â”€â”€ Normal mode: pick a number to place in the cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      header.textContent = '';
      for (let i=1; i<=9; i++) {
        const btn = document.createElement('button');
        btn.className = 'number-btn';
        btn.textContent = i;
        btn.addEventListener('click', () => this.placeNumber(i));
        numGrid.appendChild(btn);
      }
    }

    // Reflect notes-toggle state on the button
    document.getElementById('notesToggle').classList.toggle('notes-active', this.notesMode);
    popup.classList.add('active');
  }

  closePopup() {
    document.getElementById('popup').classList.remove('active');
    // Reset to position-select phase when popup closes
    this.notesPhase = 'position';
    this.notesClearMode = false;
    this.noteSelectedPos = null;
  }

  // â”€â”€ Notes-mode helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  toggleNotesMode() {
    this.notesMode = !this.notesMode;
    this.notesPhase = 'position';
    this.notesClearMode = false;
    this.noteSelectedPos = null;
    this.showPopup();
  }

  resetNotesUI() {
    this.notesMode = false;
    this.notesPhase = 'position';
    this.notesClearMode = false;
    this.noteSelectedPos = null;
  }

  selectNotePosition(pos) {
    this.noteSelectedPos = pos;
    this.notesPhase = 'number';
    this.showPopup();
  }

  placeNote(num) {
    if (this.selected===null || this.noteSelectedPos===null) return;
    const row=Math.floor(this.selected/9), col=this.selected%9;
    if (this.given[row][col] || this.grid[row][col]!==0) return;
    this.notes[row][col][this.noteSelectedPos] = num;
    this.noteSelectedPos = null;
    this.notesPhase = 'position';
    this.notesClearMode = false;
    this.saveGame();
    this.closePopup();
    this.render();
  }

  clearNote(pos) {
    if (this.selected===null) return;
    const row=Math.floor(this.selected/9), col=this.selected%9;
    delete this.notes[row][col][pos];
    this.noteSelectedPos = null;
    this.notesPhase = 'position';
    this.notesClearMode = false;
    this.saveGame();
    this.closePopup();
    this.render();
  }

  // â”€â”€ Number placement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  placeNumber(num) {
    if (this.selected===null) return;
    const row=Math.floor(this.selected/9), col=this.selected%9;
    if (this.given[row][col]) return;
    this.history.push({index:this.selected, value:this.grid[row][col], notes:JSON.parse(JSON.stringify(this.notes[row][col]))});
    this.grid[row][col] = num;
    this.notes[row][col] = {}; // clear notes on this cell when number placed
    this.lastNumber = num;
    this.saveGame();
    this.closePopup();
    this.render();
    if (this.isComplete()) this.checkSolution();
  }

  // â”€â”€ Clear handler (normal clear or notes-clear trigger) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  handleClear() {
    if (this.selected===null) return;
    const row=Math.floor(this.selected/9), col=this.selected%9;
    if (this.given[row][col]) return;

    if (this.notesMode) {
      // Enter clear-note position-selection mode
      this.notesClearMode = true;
      this.notesPhase = 'position';
      this.noteSelectedPos = null;
      this.showPopup();
      return;
    }

    // Normal clear
    this.history.push({index:this.selected, value:this.grid[row][col], notes:JSON.parse(JSON.stringify(this.notes[row][col]))});
    this.grid[row][col] = 0;
    this.saveGame();
    this.closePopup();
    this.render();
  }

  // â”€â”€ Undo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  undo() {
    if (!this.history.length) return;
    const last=this.history.pop();
    const row=Math.floor(last.index/9), col=last.index%9;
    this.grid[row][col] = last.value;
    if (last.notes) this.notes[row][col] = last.notes;
    this.selected = last.index;
    this.saveGame();
    this.render();
  }

  // â”€â”€ Win detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  isComplete() {
    for (let i=0; i<9; i++) for (let j=0; j<9; j++) if (!this.grid[i][j]) return false;
    return true;
  }

  checkSolution() {
    if (this.isValidCompleteSolution()) {
      this.stats[this.level]++;
      localStorage.setItem('sudokuStats', JSON.stringify(this.stats));
      this.updateStats();
      this.clearSavedGame();
      this.showMessage('ğŸ‰ Congratulations! You solved it!', 'success');
      setTimeout(() => this.newGame(), 3000);
    } else {
      this.showMessage('âŒ Incorrect solution. <span class="restart-link" onclick="game.confirmRestart()">Restart?</span>', 'error');
      document.getElementById('grid').classList.add('error-border');
      setTimeout(() => {
        this.hideMessage();
        document.getElementById('grid').classList.remove('error-border');
      }, 5000);
    }
  }

  isValidCompleteSolution() {
    for (let i=0; i<9; i++) {
      const row=new Set(), col=new Set();
      for (let j=0; j<9; j++) {
        if (this.grid[i][j]<1||this.grid[i][j]>9||row.has(this.grid[i][j])) return false;
        row.add(this.grid[i][j]);
        if (this.grid[j][i]<1||this.grid[j][i]>9||col.has(this.grid[j][i])) return false;
        col.add(this.grid[j][i]);
      }
    }
    for (let br=0; br<3; br++) for (let bc=0; bc<3; bc++) {
      const box=new Set();
      for (let i=0; i<3; i++) for (let j=0; j<3; j++) {
        const v=this.grid[br*3+i][bc*3+j];
        if (box.has(v)) return false;
        box.add(v);
      }
    }
    return true;
  }

  confirmRestart() {
    if (confirm('Restart this game?')) this.newGame();
  }

  confirmNewGame() {
    if (confirm('Start a new game? Current progress will be lost.')) this.newGame();
  }

  // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  render() {
    const cells=document.querySelectorAll('.cell');
    const selRow=this.selected!==null ? Math.floor(this.selected/9) : -1;
    const selCol=this.selected!==null ? this.selected%9 : -1;
    const selNum=this.selected!==null ? this.grid[selRow][selCol] : 0;

    cells.forEach((cell, index) => {
      const row=Math.floor(index/9), col=index%9;
      const value=this.grid[row][col];
      const cellNotes=this.notes[row][col];
      const hasNotes=Object.keys(cellNotes).length>0;

      // Clear cell content
      cell.innerHTML='';
      cell.className='cell';

      // Set classes
      if (this.given[row][col]) cell.classList.add('given');
      else if (value) cell.classList.add('filled');
      if (index===this.selected) cell.classList.add('selected');
      if (selNum>0 && value===selNum) cell.classList.add('same-number-highlight');

      // Conflict detection (only for user-placed numbers)
      if (value>0 && !this.given[row][col]) {
        let conflict=false;
        for (let i=0; i<9; i++) {
          if (i!==col && this.grid[row][i]===value) conflict=true;
          if (i!==row && this.grid[i][col]===value) conflict=true;
        }
        const br=Math.floor(row/3)*3, bc=Math.floor(col/3)*3;
        for (let i=0; i<3; i++) for (let j=0; j<3; j++) {
          const r=br+i, c=bc+j;
          if ((r!==row||c!==col) && this.grid[r][c]===value) conflict=true;
        }
        if (conflict) cell.classList.add('conflict');
      }

      // Render value or notes
      if (value) {
        cell.textContent = value;
      } else if (hasNotes) {
        // Show small notes in the 3Ã—3 positions inside the cell
        const notesGrid = document.createElement('div');
        notesGrid.className = 'cell-notes';
        for (let pos=1; pos<=9; pos++) {
          const slot = document.createElement('div');
          slot.className = 'cell-note';
          // Centre slot (pos 5) intentionally left blank
          if (pos!==5 && cellNotes[pos]) slot.textContent = cellNotes[pos];
          notesGrid.appendChild(slot);
        }
        cell.appendChild(notesGrid);
      }
    });
  }

  // â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  showMessage(text, type) {
    const msg=document.getElementById('message');
    msg.innerHTML=text;
    msg.className=`message ${type}`;
    msg.classList.remove('hidden');
  }

  hideMessage() { document.getElementById('message').classList.add('hidden'); }

  updateStats() {
    document.getElementById('easyWins').textContent   = this.stats.easy;
    document.getElementById('mediumWins').textContent = this.stats.medium;
    document.getElementById('hardWins').textContent   = this.stats.hard;
  }

  // â”€â”€ PWA install â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  installApp() {
    if (this.deferredPrompt) {
      this.deferredPrompt.prompt();
      this.deferredPrompt.userChoice.then(choice => {
        if (choice.outcome==='accepted') {
          this.showMessage('âœ… App installed!', 'success');
          setTimeout(() => this.hideMessage(), 3000);
        }
        this.deferredPrompt=null;
      });
    } else {
      this.showMessage('â„¹ï¸ iOS: Share > Add to Home Screen. Android: browser menu > Install App.', 'success');
      setTimeout(() => this.hideMessage(), 6000);
    }
  }

  checkPWAInstalled() {
    if (window.matchMedia('(display-mode:standalone)').matches || window.navigator.standalone===true) {
      document.getElementById('installBtn').style.display='none';
    }
  }

  // â”€â”€ Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  saveGame() {
    localStorage.setItem('sudokuGame2', JSON.stringify({
      grid:this.grid, solution:this.solution, given:this.given,
      level:this.level, history:this.history, selected:this.selected,
      lastNumber:this.lastNumber, notes:this.notes
    }));
  }

  loadGame() {
    const saved = localStorage.getItem('sudokuGame2');
    if (saved) {
      try {
        const s=JSON.parse(saved);
        this.grid       = s.grid;
        this.solution   = s.solution;
        this.given      = s.given;
        this.level      = s.level;
        this.history    = s.history || [];
        this.selected   = s.selected;
        this.lastNumber = s.lastNumber || 0;
        this.notes      = s.notes || Array(9).fill(null).map(()=>Array(9).fill(null).map(()=>({})));
        document.querySelectorAll('.diff-btn').forEach(btn =>
          btn.classList.toggle('active', btn.dataset.level===this.level)
        );
        this.render();
        return;
      } catch(e) {
        console.error('Failed to load saved game', e);
      }
    }
    this.newGame();
  }

  clearSavedGame() { localStorage.removeItem('sudokuGame2'); }
}

const game = new SudokuGame();
</script>
</body>
</html>
