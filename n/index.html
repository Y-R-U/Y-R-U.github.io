<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebRTC STUN Peer Test (manual copy/paste)</title>
  <style>
    body { margin:0; font:14px system-ui, sans-serif; background:#0b1220; color:#e8eef9; }
    header { padding:10px; display:flex; flex-wrap:wrap; gap:8px; border-bottom:1px solid #1e2a44; }
    input, textarea { background:#0e172a; color:#e8eef9; border:1px solid #1e2a44; border-radius:6px; padding:6px; }
    textarea { width:100%; resize:vertical; min-height:80px; font-family:monospace; }
    button { background:#15233d; color:#e8eef9; border:1px solid #29406e; border-radius:6px; padding:6px 10px; cursor:pointer; }
    main { padding:10px; }
    .log { background:#0c1426; border:1px solid #1e2a44; border-radius:8px; padding:10px; min-height:50vh; font-family:monospace; font-size:12px; white-space:pre-wrap; overflow:auto; }
  </style>
</head>
<body>
  <header>
    <input id="name" type="text" placeholder="Your name" />
    <button id="randName">Set User_SS</button>
    <button id="btnCreateOffer">Creator: Create Offer</button>
    <button id="btnSetOfferCreateAnswer">User: Set Remote Offer → Create Answer</button>
    <button id="btnSetAnswer">Creator: Set Remote Answer</button>
    <button id="btnCopyOut">Copy Out</button>
    <button id="btnPasteIn">Paste In</button>
    <button id="btnReset">Reset</button>
  </header>
  <main>
    <h3>Signal to Send</h3>
    <textarea id="signalOut"></textarea>
    <h3>Signal from Other</h3>
    <textarea id="signalIn"></textarea>
    <h3>Logs</h3>
    <div id="log" class="log"></div>
  </main>
  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const logEl = $("log");
    function log(msg){
      const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.textContent += line + "\n";
      logEl.scrollTop = logEl.scrollHeight;
      console.log(line);
    }

    let pc, dc;
    const iceServers = [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' }
    ];

    function newPC(){
      pc = new RTCPeerConnection({iceServers});
      pc.onicecandidate = e => {
        if(e.candidate){ log("ICE candidate: "+e.candidate.candidate); }
        else { log("ICE candidate gathering complete"); updateSignalOut(); dumpCandidates(); }
      };
      pc.onicecandidateerror = e => {
        log(`ICE candidate ERROR: ${e.errorText||e.errorCode}`);
      };
      pc.oniceconnectionstatechange = ()=>{ log("iceConnectionState → "+pc.iceConnectionState); };
      pc.onconnectionstatechange = ()=>{ log("connectionState → "+pc.connectionState); };
      pc.onsignalingstatechange = ()=>{ log("signalingState → "+pc.signalingState); };
      pc.ondatachannel = ev=>{ dc=ev.channel; bindDC(); log("Got DataChannel"); };
    }

    function bindDC(){
      dc.onopen=()=>log("DataChannel open");
      dc.onmessage=e=>log("Message: "+e.data);
      dc.onclose=()=>log("DataChannel closed");
      dc.onerror=e=>log("DataChannel error: "+e.message);
    }

    function stringify(desc){ return JSON.stringify({type:desc.type,sdp:desc.sdp}); }
    function parse(text){ return new RTCSessionDescription(JSON.parse(text)); }
    function updateSignalOut(){ if(pc.localDescription) $("signalOut").value=stringify(pc.localDescription); }

    async function waitIce(){
      if(pc.iceGatheringState==="complete") return;
      await new Promise(r=>{ pc.addEventListener("icegatheringstatechange",()=>{ if(pc.iceGatheringState==="complete") r(); }); });
    }

    async function dumpCandidates(){
      try {
        const stats=await pc.getStats();
        stats.forEach(r=>{ if(r.type==="local-candidate"){ log(`Local candidate: type=${r.candidateType} ip=${r.ip||r.address} port=${r.port}`); } });
      }catch(e){ log("dumpCandidates error: "+e.message); }
    }

    $("btnCreateOffer").onclick=async()=>{
      newPC();
      dc=pc.createDataChannel("test");
      bindDC();
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
      await waitIce();
      updateSignalOut();
      log("Offer created");
    };

    $("btnSetOfferCreateAnswer").onclick=async()=>{
      newPC();
      const remote=parse($("signalIn").value);
      await pc.setRemoteDescription(remote);
      const ans=await pc.createAnswer();
      await pc.setLocalDescription(ans);
      await waitIce();
      updateSignalOut();
      log("Answer created");
    };

    $("btnSetAnswer").onclick=async()=>{
      const remote=parse($("signalIn").value);
      await pc.setRemoteDescription(remote);
      log("Answer set");
    };

    $("btnCopyOut").onclick=()=>{ navigator.clipboard.writeText($("signalOut").value); };
    $("btnPasteIn").onclick=async()=>{ $("signalIn").value=await navigator.clipboard.readText(); };
    $("btnReset").onclick=()=>{ if(pc){pc.close();} pc=null; dc=null; $("signalOut").value=""; $("signalIn").value=""; log("Reset"); };
    $("randName").onclick=()=>{ $("name").value="User_"+(Math.floor(Date.now()/1000)%60); };

    log("Loaded");
  })();
  </script>
</body>
</html>
